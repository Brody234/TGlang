#!/usr/bin/env python3
import os, sys, argparse
from pathlib import Path

def load_env_file(p: Path):
    if not p.exists():
        return
    for line in p.read_text().splitlines():
        s = line.strip()
        if not s or s.startswith("#"):
            continue
        k, v = [t.strip() for t in s.split("=", 1)]
        os.environ[k] = v

# Load gemini.env from CWD or script dir
for cand in (Path.cwd()/"gemini.env", Path(__file__).resolve().parent/"gemini.env"):
    load_env_file(cand)

GEMINI_KEY = os.environ.get("GEMINI_KEY")

parser = argparse.ArgumentParser(prog="gemini", add_help=True)
parser.add_argument("--model", default=os.environ.get("GEMINI_MODEL", "models/gemini-2.5-pro"),
                    help="Model id (or set GEMINI_MODEL). Default: models/gemini-2.5-pro")
parser.add_argument("--list", action="store_true", help="List available models and exit")
parser.add_argument("prompt", nargs="?", help="Prompt to send")
args = parser.parse_args()

if not GEMINI_KEY:
    print("GEMINI_KEY missing. Put it in gemini.env as: GEMINI_KEY=... ", file=sys.stderr)
    sys.exit(2)

try:
    import google.generativeai as genai
except ImportError:
    print("Missing dependency: google-generativeai. Install: pip install google-generativeai",
          file=sys.stderr)
    sys.exit(2)

genai.configure(api_key=GEMINI_KEY)

if args.list:
    # Show models that support generateContent
    try:
        models = list(genai.list_models())
    except Exception as e:
        print(f"[list error] {e}", file=sys.stderr)
        sys.exit(1)

    print("Models supporting generateContent:")
    for m in models:
        # Some SDK versions expose `supported_generation_methods`
        methods = getattr(m, "supported_generation_methods", []) or []
        if "generateContent" in methods or "generate_text" in methods:
            print(f"  - {m.name}")
    sys.exit(0)

if not args.prompt:
    print("Usage:\n  gemini [--model MODEL] 'your prompt here'\n  gemini --list",
          file=sys.stderr)
    sys.exit(2)

model_id = args.model

# Try to generate; if 404, suggest listing models
try:
    model = genai.GenerativeModel(model_id)
    resp = model.generate_content(args.prompt)
    text = (getattr(resp, "text", None) or "").strip()
    # Fallback if .text missing on older SDKs
    if not text and getattr(resp, "candidates", None):
        for c in resp.candidates:
            parts = getattr(getattr(c, "content", None), "parts", None) or []
            for p in parts:
                if getattr(p, "text", None):
                    text += p.text
    print(text.strip())
except Exception as e:
    msg = str(e)
    if "404" in msg and "models/" in msg:
        print(f"[gemini error] {msg}\n"
              f"Hint: try a different model, e.g.:\n"
              f"  gemini --model gemini-1.5-pro-002 '...'\n"
              f"  gemini --model gemini-1.5-flash-002 '...'\n"
              f"Or list models with:\n"
              f"  gemini --list",
              file=sys.stderr)
    else:
        print(f"[gemini error] {msg}", file=sys.stderr)
    sys.exit(1)
